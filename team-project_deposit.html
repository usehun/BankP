<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>예금 상품 가입</title>

    <link rel="stylesheet" href="css/project_library.css">
    <link rel="stylesheet" href="css/project_deposit.css">

</head>

<body>
    <header class="header">
        <div class="nav-left">
            <a href="team-project_main.html">&larr; HOME</a>
        </div>

        <div class="popoverSection">
            <button class="login_btn" onclick="logout()">LOGOUT</button>
            <button id="logoutSection" style="display: none">LOGOUT</button>
            <div id="loginSection" style="display: none;">
                <h2>로그인</h2>
                <p>
                    이메일 :
                    <input type="email" id="email" />
                </p>
                <p>
                    비밀번호 :
                    <input type="password" id="pw" />
                </p>
                <button>로그인</button>
            </div>
        </div>
    </header>

    <h1>예금 상품 가입</h1>
    <div id="addSection">
        <h2 class="section-title">예금 정보 입력하기</h2>

        <div class="form-group">
            <label for="depositType">예금 종류</label>
            <select id="depositType" class="form-control">
                <option disabled selected>예치할 상품을 선택하세요.</option>
                <option>보통예금</option>
                <option>정기예금</option>
                <option>자유적립예금</option>
                <option>거치식예금</option>
            </select>
        </div>

        <div class="form-group">
            <label for="date">시작 날짜</label>
            <input type="date" id="date" class="form-control">
        </div>

        <div class="form-group">
            <label for="depositAmount">예금 금액</label>
            <input type="number" id="depositAmount" class="form-control" min="10000" step="10000"
                placeholder="얼마를 예치하시겠습니까?">
        </div>

        <div class="form-row">
            <div class="form-group half">
                <label for="depositPeriod">예치 기간 (개월)</label>
                <input type="number" id="depositPeriod" class="form-control" placeholder="예치할 개월 수를 입력하세요.">
            </div>

            <div class="form-group half">
                <label for="interestRate">적용 금리 선택</label>
                <select id="interestRate" class="form-control">
                    <option disabled selected>상품에 따라 적용되는 금리를 선택하세요.</option>
                    <option value="1.5">1.5%</option>
                    <option value="2.0">2.0%</option>
                    <option value="2.5">2.5%</option>
                    <option value="3.0">3.0%</option>
                </select>
            </div>

        </div>

        <div class="form-row">
            <div class="form-group bank-select">
                <label for="bank">이자 입금 계좌</label>
                <select id="bank" name="bank" class="form-control">
                    <option disabled selected>은행을 선택하세요</option>
                    <option value="shinhan">신한은행</option>
                    <option value="kb">국민은행</option>
                    <option value="woori">우리은행</option>
                    <option value="nonghyup">농협</option>
                    <option value="kakao">카카오뱅크</option>
                    <option value="toss">토스뱅크</option>
                </select>
            </div>

            <div class="form-group account-input">
                <label for="interestAccount">계좌번호</label>
                <input type="text" id="interestAccount" class="form-control" placeholder="예: 110-123-456789">
            </div>
        </div>


        <button class="submit-btn">예금 신청</button>
    </div>


    <h2 class="sub-title">나의 예금 내역</h2>
    <ul id="depositList"></ul>


    <footer>
        <p>© 2025 금융 서비스. All rights reserved.</p>
    </footer>


    <script>
        const LOGIN_API_BASE = "https://683d0a9d199a0039e9e409f6.mockapi.io/api/BankP";
        const DEPOSIT_API_BASE = "https://683d51d1199a0039e9e4f0ca.mockapi.io/api/v1/";

        let user = null;

        // 로그인 검증함수
        function isLogin(user) {
            if (!user) {
                alert('로그인이 필요합니다');
                location.href = 'team-project_main.html';
                return;
            }
        }

        // 로그인 함수
        function login() {
            const email = document.getElementById('email').value;
            const pw = document.getElementById('pw').value;
            fetch(`${LOGIN_API_BASE}/users`)
                .then(res => res.json())
                .then(users => {
                    const found = users.find(u => u.userEmail === email && u.userPW === pw);
                    if (found) {
                        user = found;
                        localStorage.setItem('user', JSON.stringify(user));
                        alert('로그인 성공');

                        loadDeposits();
                    } else {
                        alert('계정 정보가 일치하지 않습니다');
                    }
                })
                .catch(() => alert("서버 오류로 로그인 실패"));
        }

        // 로그인 버튼 이벤트
        document.querySelector('#loginSection button').onclick = login;

        // 로그아웃 함수
        function logout() {
            localStorage.removeItem('user');
            user = null;
            document.getElementById('depositList').innerHTML = '';
            alert('로그아웃 성공');

            // 메인 페이지로 이동
            window.location.href = 'team-project_main.html';
        }

        // 로그아웃 버튼 이벤트
        document.querySelector('#logoutSection').onclick = logout;


        // 예금 등록
        document.querySelector("#addSection button").onclick = function () {
            if (!user) {
                alert("로그인이 필요합니다.");
                return;
            }

            const data = {
                user_email: user.userEmail,
                type: document.getElementById("depositType").value,
                date: document.getElementById("date").value,
                amount: document.getElementById("depositAmount").value,
                period: document.getElementById("depositPeriod").value,
                rate: document.getElementById("interestRate").value,
                bank: document.getElementById("bank").value,
                account: document.getElementById("interestAccount").value
            };

            for (let key in data) {
                if (!data[key]) {
                    alert("모든 항목을 입력해주세요.");
                    return;
                }
            }

            fetch(`${DEPOSIT_API_BASE}/deposits`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            })
                .then(() => {
                    alert("예금이 저장되었습니다!");
                    loadDeposits();
                });
        };


        // 예금 불러오기
        function loadDeposits() {
            fetch(`${DEPOSIT_API_BASE}/deposits?user_email=${user.userEmail}`)
                .then(res => res.json())
                .then(data => {
                    const list = document.getElementById("depositList");
                    list.innerHTML = "";

                    if (!data.length) {
                        list.innerHTML = "<li>예금 내역이 없습니다.</li>";
                        return;
                    }

                    for (let d of data) {
                        list.innerHTML +=
                            `<li class="deposit-card">
                        <div class="deposit-info">
                            <div>${d.type} • ${d.date}</div>
                            <div class="period-rate">${d.period}개월 / ${d.rate}%</div>
                            <div>${d.bank} ${d.account}</div>
                        </div>
                        <div class="deposit-meta-actions">
                            <div class="deposit-amount">${Number(d.amount).toLocaleString()}원</div>
                            <div class="deposit-actions">
                                <button onclick="editDeposit('${d.id}', ${d.amount})">수정</button>
                                <button onclick="deleteDeposit('${d.id}')">삭제</button>
                            </div>
                        </div>
                    </li>`;
                    }
                });
        }


        // 예금 수정
        function editDeposit(id, oldAmount) {
            const newAmount = prompt("새 금액을 입력하세요", oldAmount);
            if (!newAmount) return;

            fetch(`${DEPOSIT_API_BASE}/deposits/${id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ amount: +newAmount })
            }).then(() => loadDeposits());
        }


        // 예금 삭제
        function deleteDeposit(id) {
            fetch(`${DEPOSIT_API_BASE}/deposits/${id}`, {
                method: "DELETE"
            }).then(() => loadDeposits());
        }


        window.onload = function () {
            const saved = localStorage.getItem('user');
            isLogin(saved);

            if (saved) {
                user = JSON.parse(saved);
                loadDeposits();
            }
        };
    </script>




</body>

</html>