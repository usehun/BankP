<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="css/project_library.css" />
    <link rel="stylesheet" href="css/project_fund.css" />
    <title>펀드</title>
</head>

<body>
    <header class="header">
        <div class="nav-left">
            <a href="team-project_main.html">&larr; HOME</a>
        </div>
        <div class="nav-right">
            <button id="logoutSection" class="logout-btn">LOGOUT</button>
        </div>
    </header>
    <main class="container">
        <h1 class="mainSec-title">펀드 상품 조회 및 가입</h1>
        <section class="main-section">
            <section class="list-section">
                <h3>내 펀드 목록</h3>
                <div class="item">
                    <p>펀드명</p>
                    <p>유형</p>
                    <p>수익률</p>
                    <p>설정일</p>
                    <p>상태</p>
                </div>
                <div class="item">
                    <p></p>
                </div>
            </section>
        </section>
        <section class="recommend-section">
            <section class="list-section">
                <h3>추천 펀드 목록</h3>
                <div class="item">
                    <p>펀드명</p>
                    <p>유형</p>
                    <p>수익률</p>
                    <p>상태</p>
                </div>
            </section>
        </section>
    </main>
    <footer>
        <p>ⓒ 2025 금융 서비스, All right reserved</p>
    </footer>
    <script>
        // 펀드 정보 불러오기
        const API_BASE = 'https://683fa62c5b39a8039a553280.mockapi.io/api/BankP/fund/';

        let user = null;

        //내 펀드 리스트 받기
        function loadMyFund() {
            const user = JSON.parse(localStorage.getItem('user'));

            if (!user) {
                alert('로그인이 필요합니다');
                location.href = 'team-project_main.html';
                return;
            }

            fetch(API_BASE + 'users_fund')
                .then(res => res.json())
                .then(funds => {

                    const section = document.querySelector('.main-section .list-section');
                    // list 초기화
                    const items = section.querySelectorAll('.item');
                    items.forEach((el, idx) => {
                        if (idx > 0) el.remove();
                    });
                    // list 필터링
                    const my_fund = funds.filter(f => f.userEmail === user.userEmail);

                    if (my_fund.length === 0) {
                        const empthyRow = document.createElement('div');
                        empthyRow.className = 'item';
                        empthyRow.innerHTML = '<p>펀드없음</p>';
                        section.appendChild(empthyRow);
                        return;
                    }

                    my_fund.forEach(fund => {
                        const div = document.createElement('div');

                        let displayName = fund.name;
                        if (displayName.length > 7) {
                            displayName = displayName.slice(0, 7) + '...';
                        }

                        div.className = 'item deposit-card';
                        div.innerHTML = `
                            <p title=${fund.name}>${displayName}</p>
                            <p>${fund.type}</p>
                            <p>${fund.reve_per}</p>
                            <p>${fund.date}</p>
                            <p>${fund.state}</p>
                            `;
                        //삭제 버튼 추가
                        const delBtn = document.createElement('button');
                        delBtn.textContent = '삭제';
                        delBtn.className = 'btn-r';
                        delBtn.addEventListener('click', () => {
                            deleteFund(fund.id);
                        });

                        div.appendChild(delBtn);
                        section.appendChild(div);
                    })
                })
        }
        //추천 펀드 리스트 받기
        function loadRecoFund() {
            fetch(API_BASE + 'reco_fund')
                .then(res => res.json())
                .then(funds => {

                    const section = document.querySelector('.recommend-section .list-section');
                    section.querySelectorAll('.item').forEach(el => el.remove);

                    if (funds.length === 0) {
                        const empthyRow = document.createElement('div');
                        empthyRow.className = 'item';
                        empthyRow.innerHTML = '<p>펀드없음</p>';
                        section.appendChild(empthyRow);
                        return;
                    }

                    funds.forEach((fund, index) => {
                        const div = document.createElement('div');

                        let displayName = fund.name;
                        if (displayName.length > 7) {
                            displayName = displayName.slice(0, 7) + '...';
                        }

                        div.className = 'item deposit-card';
                        div.id = `i${index}`;

                        div.innerHTML = `
                            <p title=${fund.name}>${displayName}</p>
                            <p>${fund.type}</p>
                            <p>${fund.reve_per}</p>
                            <p>${fund.state}</p>
                        `;
                        //추가 버튼
                        const addBtn = document.createElement('button');
                        addBtn.textContent = '추가';
                        addBtn.className = 'btn-g';
                        addBtn.addEventListener('click', () => {
                            addMyFund(fund, div);
                        });

                        div.appendChild(addBtn);

                        section.appendChild(div);
                    })
                })
        }
        // 내 펀드 추가
        function addMyFund(fund, divElement) {
            alert('펀드 가입을 승인중입니다')

            const user = JSON.parse(localStorage.getItem('user'));
            if (!user) {
                alert('잘못된 접근입니다');
                location.href = '/';
                return;
            }

            const today = new Date();
            const formatDateToString = today.toISOString().split('T')[0];

            //전송할 펀드 데이터
            const myFund = {
                ...fund,
                userEmail: user.userEmail,
                date: formatDateToString,
                state: '보유중'
            };

            fetch(API_BASE + 'users_fund', {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(myFund)
            })
                .then(res => res.json())
                .then(data => {
                    alert('펀드 가입이 완료되었습니다');

                    //서버에서 추천 펀드 제거
                    fetch(API_BASE + 'reco_fund/' + fund.id, {
                        method: 'DELETE'
                    }).then(() => {
                        //화면에서도 제거
                        if (divElement) divElement.remove();
                    });

                    // 3. 내 펀드 목록 갱신
                    loadMyFund();


                    loadMyFund(); // 내 펀드 목록 갱신
                })
                .catch(err => {
                    console.error(err);
                    alert('펀드를 추가하던 도중 오류가 발생했습니다')
                })
        }
        // 내 펀드 삭제
        function deleteFund(id) {
            if (!confirm('정말로 이 펀드를 삭제하시겠습니까?')) return;

            fetch(API_BASE + 'users_fund/' + id, {
                method: 'DELETE'
            })
                .then(res => {
                    if (!res.ok) throw new Error('삭제 실패');
                    alert('삭제되었습니다.');
                    loadMyFund(); // 목록 다시 불러오기
                })
                .catch(err => {
                    console.error(err);
                    alert('삭제 중 오류가 발생했습니다.');
                });
        }

        // 로그아웃 기능 구현
        window.onload = function () {
            const savedUser = localStorage.getItem('user');
            // if (!savedUser) {
            //     alert('로그인이 필요합니다.');
            //     location.href = '/'; // 로그인 또는 메인 페이지로 이동
            //     return;
            // }

            user = JSON.parse(savedUser);
            loadMyFund();
            loadRecoFund();

            const logoutBtn = document.getElementById('logoutSection');
            logoutBtn.addEventListener('click', () => {
                localStorage.removeItem('user');
                alert('로그아웃되었습니다.');
                location.href = 'team-project_main.html'; // 로그인 페이지나 메인 페이지로 리디렉션
            });
        }
    </script>
</body>

</html>